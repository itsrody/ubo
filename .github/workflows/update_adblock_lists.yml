name: uBlock Super List Generator

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at 00:00 UTC

jobs:
  generate-lists:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      MAX_DOWNLOAD_WORKERS: 8
      CONFIG_FILE: adblock_config.json
      OUTPUT_DIR: optimized_lists

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Validate config file
      run: |
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "::error::Config file $CONFIG_FILE not found!"
          exit 1
        fi
        echo "✅ Config file exists"

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run adblock converter
      run: python adblock_converter.py
      env:
        MAX_DOWNLOAD_WORKERS: ${{ env.MAX_DOWNLOAD_WORKERS }}
        CONFIG_FILE: ${{ env.CONFIG_FILE }}

    - name: Configure Git
      run: |
        git config user.name "uBlock Super List Generator"
        git config user.email "ublock-automation@users.noreply.github.com"
        git config pull.rebase false

    - name: Stage changes
      id: stage
      run: |
        git add ${{ env.OUTPUT_DIR }}/*
        echo "changes_exist=$(git diff-index --quiet HEAD -- || echo 'true')" >> $GITHUB_OUTPUT

    - name: Commit changes
      if: steps.stage.outputs.changes_exist == 'true'
      run: |
        git commit -m "🔧 Update adblock lists - $(date +'%Y-%m-%d %H:%M UTC')" 
        echo "COMMIT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV

    - name: Push changes
      if: steps.stage.outputs.changes_exist == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}

    - name: Update report
      run: |
        echo "### 🛠️ uBlock List Update Report" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ steps.stage.outputs.changes_exist }}" == 'true' ]]; then
          echo "✅ Updated adblock lists!" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: [${{ env.COMMIT_SHA }}](https://github.com/${{ github.repository }}/commit/${{ env.COMMIT_SHA }})" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u)" >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ No changes detected - lists are up-to-date" >> $GITHUB_STEP_SUMMARY
          echo "Last run: $(date -u)" >> $GITHUB_STEP_SUMMARY
        fi
